{% extends 'base.html' %}

{% block title %}Dashboard de Caixa - Cl√≠nica{% endblock %}

{% block content %}
<div class="py-8 px-4 sm:px-6 lg:px-8">
    <!-- Header -->
    <div class="mb-8 flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-slate-900 mb-2">
                <i class="fas fa-cash-register text-purple-600 mr-3"></i>Dashboard de Caixa
            </h1>
            <p class="text-slate-600">Controle completo de entradas e sa√≠das</p>
        </div>
        
        {% if not sem_caixa_aberto %}
        <!-- Dropdown para consultar caixas anteriores -->
        <div class="flex gap-3 items-center">
            <select onchange="if(this.value) window.location.href='?caixa_id=' + this.value" class="px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500">
                <option value="">üìã Consultar Caixa Anterior</option>
                {% for cx in caixas_anteriores %}
                <option value="{{ cx.id }}" {% if caixa_atual.id == cx.id %}selected{% endif %}>
                    {{ cx.data_abertura|date:"d/m/Y H:i" }}
                    {% if cx.aberto %}(Aberto){% else %}(Fechado - R$ {{ cx.saldo_final|floatformat:2 }}){% endif %}
                </option>
                {% endfor %}
            </select>
            
            {% if modo_consulta %}
            <a href="{% url 'dashboard_caixa' %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                <i class="fas fa-arrow-left mr-2"></i>Voltar ao Caixa Atual
            </a>
            {% endif %}
        </div>
        {% endif %}
    </div>

    {% if sem_caixa_aberto %}
    <!-- Sem Caixa Aberto -->
    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-6 rounded-lg mb-6">
        <div class="flex items-center mb-4">
            <i class="fas fa-exclamation-triangle text-yellow-600 text-3xl mr-4"></i>
            <div>
                <h3 class="text-lg font-bold text-yellow-900">Nenhum Caixa Aberto</h3>
                <p class="text-yellow-700">Voc√™ precisa abrir o caixa para come√ßar a registrar movimenta√ß√µes.</p>
            </div>
        </div>
        <a href="{% url 'abrir_caixa' %}" class="inline-block px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold">
            <i class="fas fa-lock-open mr-2"></i>Abrir Caixa Agora
        </a>
    </div>
    
    <!-- Hist√≥rico de Caixas Fechados -->
    {% if caixas_anteriores %}
    <div class="bg-white rounded-lg shadow p-6">
        <h3 class="text-lg font-bold text-slate-900 mb-4">
            <i class="fas fa-history text-purple-600 mr-2"></i>Caixas Anteriores
        </h3>
        <div class="grid gap-4">
            {% for cx in caixas_anteriores %}
            <a href="?caixa_id={{ cx.id }}" class="block p-4 border border-slate-200 rounded-lg hover:bg-slate-50 transition">
                <div class="flex justify-between items-center">
                    <div>
                        <p class="font-bold text-slate-900">{{ cx.data_abertura|date:"d/m/Y H:i" }}</p>
                        <p class="text-sm text-slate-600">
                            Fechado em: {{ cx.data_fechamento|date:"d/m/Y H:i" }}
                        </p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm text-slate-600">Saldo Final</p>
                        <p class="text-xl font-bold text-blue-600">R$ {{ cx.saldo_final|floatformat:2 }}</p>
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    {% else %}
    
    <!-- Status do Caixa -->
    <div class="bg-white rounded-lg shadow p-6 mb-6">
        <div class="flex justify-between items-center">
            <div>
                <p class="text-sm text-slate-600 mb-1">Caixa Atual</p>
                <p class="text-xl font-bold text-slate-900">
                    Aberto em: {{ caixa_atual.data_abertura|date:"d/m/Y H:i" }}
                </p>
                {% if modo_consulta and not caixa_atual.aberto %}
                <p class="text-sm text-slate-600 mt-1">
                    <i class="fas fa-lock text-red-600 mr-1"></i>
                    Fechado em: {{ caixa_atual.data_fechamento|date:"d/m/Y H:i" }}
                </p>
                {% endif %}
            </div>
            
            {% if not modo_consulta %}
            <div class="flex gap-3">
                <span class="px-4 py-2 bg-green-100 text-green-800 rounded-lg font-medium flex items-center">
                    <i class="fas fa-check-circle mr-2"></i>Caixa Aberto
                </span>
                <a href="{% url 'fechar_caixa' %}" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-medium">
                    <i class="fas fa-lock mr-2"></i>Fechar Caixa
                </a>
                {% if modo_consulta and not caixa_atual.aberto %}
                <a href="{% url 'relatorio_fechamento_caixa' caixa_atual.id %}" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium">
                    <i class="fas fa-file-pdf mr-2"></i>Ver Relat√≥rio
                </a>
                {% endif %}
            </div>
            {% else %}
            <span class="px-4 py-2 bg-slate-100 text-slate-800 rounded-lg font-medium flex items-center">
                <i class="fas fa-eye mr-2"></i>Modo Consulta
            </span>
            {% endif %}
        </div>
    </div>

    <!-- Cards de Estat√≠sticas -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Saldo Inicial -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-blue-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-600 text-sm font-medium">Saldo Inicial</p>
                    <p class="text-3xl font-bold text-blue-600 mt-2">
                        R$ {{ stats.saldo_inicial|floatformat:2 }}
                    </p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="fas fa-wallet text-blue-600 text-2xl"></i>
                </div>
            </div>
        </div>
        
        <!-- Total Entradas -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-green-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-600 text-sm font-medium">Entradas</p>
                    <p class="text-3xl font-bold text-green-600 mt-2">
                        R$ {{ stats.total_entradas|floatformat:2 }}
                    </p>
                </div>
                <div class="bg-green-100 p-3 rounded-full">
                    <i class="fas fa-arrow-up text-green-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Total Sa√≠das -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-red-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-600 text-sm font-medium">Sa√≠das</p>
                    <p class="text-3xl font-bold text-red-600 mt-2">
                        R$ {{ stats.total_saidas|floatformat:2 }}
                    </p>
                </div>
                <div class="bg-red-100 p-3 rounded-full">
                    <i class="fas fa-arrow-down text-red-600 text-2xl"></i>
                </div>
            </div>
        </div>

        <!-- Saldo Final -->
        <div class="bg-white rounded-lg shadow p-6 border-l-4 border-purple-500">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-slate-600 text-sm font-medium">Saldo Atual</p>
                    <p class="text-3xl font-bold text-purple-600 mt-2">
                        R$ {{ stats.saldo|floatformat:2 }}
                    </p>
                </div>
                <div class="bg-purple-100 p-3 rounded-full">
                    <i class="fas fa-coins text-purple-600 text-2xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Bot√µes de A√ß√£o (s√≥ aparecem se n√£o estiver em modo consulta) -->
    {% if not modo_consulta %}
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <a href="{% url 'registrar_pagamento' %}" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-bold flex items-center justify-center gap-2">
            <i class="fas fa-plus-circle"></i>Registrar Entrada (Mensalidade)
        </a>
        <a href="{% url 'registrar_sessao_avulsa' %}" class="px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-bold flex items-center justify-center gap-2">
            <i class="fas fa-plus-circle"></i>Sess√£o Avulsa
        </a>
        <a href="{% url 'registrar_saida_caixa' %}" class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition font-bold flex items-center justify-center gap-2">
            <i class="fas fa-minus-circle"></i>Registrar Sa√≠da
        </a>
    </div>
    {% endif %}

    <!-- Movimenta√ß√µes do Per√≠odo -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <div class="p-6 border-b border-slate-200">
            <h3 class="text-lg font-bold text-slate-900">
                <i class="fas fa-list text-purple-600 mr-2"></i>Extrato de Movimenta√ß√µes
            </h3>
            <p class="text-sm text-slate-600 mt-1">{{ stats.total_movimentacoes }} movimenta√ß√£o(√µes) registrada(s)</p>
        </div>

        {% if movimentacoes %}
        <div class="overflow-x-auto">
            <table class="w-full">
                <thead class="bg-slate-50 border-b border-slate-200">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700">Data/Hora</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700">Descri√ß√£o</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700">Paciente</th>
                        <th class="px-6 py-3 text-left text-xs font-semibold text-slate-700">Tipo</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-slate-700">Entrada</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-slate-700">Sa√≠da</th>
                        <th class="px-6 py-3 text-right text-xs font-semibold text-slate-700 bg-blue-50">Saldo</th>
                    </tr>
                </thead>
                <tbody>
                    {% for mov in movimentacoes %}
                    <tr class="border-b border-slate-200 hover:bg-slate-50 transition">
                        <td class="px-6 py-4 text-sm text-slate-600 whitespace-nowrap">
                            {{ mov.data_movimentacao|date:"d/m/Y H:i" }}
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-900 font-medium">
                            {{ mov.descricao }}
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">
                            {% if mov.paciente %}
                                {{ mov.paciente.nome }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <span class="px-3 py-1 rounded-full text-xs font-semibold {% if mov.tipo == 'entrada' %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                {{ mov.get_tipo_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-sm font-bold text-right text-green-600">
                            {% if mov.tipo == 'entrada' %}R$ {{ mov.valor|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm font-bold text-right text-red-600">
                            {% if mov.tipo == 'saida' %}R$ {{ mov.valor|floatformat:2 }}{% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 text-sm font-bold text-right text-blue-600 bg-blue-50">
                            R$ {{ mov.saldo_progressivo|floatformat:2 }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="bg-slate-100 font-bold">
                    <tr>
                        <td colspan="4" class="px-6 py-4 text-right text-slate-900">TOTAIS:</td>
                        <td class="px-6 py-4 text-right text-green-600">R$ {{ stats.total_entradas|floatformat:2 }}</td>
                        <td class="px-6 py-4 text-right text-red-600">R$ {{ stats.total_saidas|floatformat:2 }}</td>
                        <td class="px-6 py-4 text-right text-purple-600 bg-purple-50 text-lg">R$ {{ stats.saldo|floatformat:2 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        {% else %}
        <div class="p-12 text-center">
            <i class="fas fa-inbox text-slate-300 text-5xl mb-4 block"></i>
            <p class="text-slate-600 text-lg font-medium">Nenhuma movimenta√ß√£o registrada neste caixa</p>
            <p class="text-slate-500 mt-1">Comece registrando uma entrada ou sa√≠da</p>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
{% endblock %}