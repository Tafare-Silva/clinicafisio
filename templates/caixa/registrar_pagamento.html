{% extends 'base.html' %}

{% block title %}Registrar Pagamento - Cl√≠nica{% endblock %}

{% block content %}
<div class="py-8 px-4 sm:px-6 lg:px-8">
  <div class="max-w-2xl mx-auto">

    <div class="mb-8">
      <a href="{% url 'dashboard_caixa' %}" class="text-purple-600 hover:text-purple-800 flex items-center gap-2 mb-4">
        <i class="fas fa-arrow-left"></i>Voltar ao Dashboard
      </a>

      <div class="flex items-start justify-between gap-4">
        <h1 class="text-3xl font-bold text-slate-900">
          <i class="fas fa-money-bill-wave text-purple-600 mr-3"></i>Registrar Pagamento
        </h1>

        <button type="button"
                id="btnAbrirModalPaciente"
                class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition font-bold flex items-center gap-2">
          <i class="fas fa-user-plus"></i>Cadastrar paciente
        </button>
      </div>
    </div>

    <div class="bg-white rounded-lg shadow-lg p-8">
      <form method="post" class="space-y-6" id="formPagamento" novalidate>
        {% csrf_token %}

        {# Campo oculto que recebe o ID da mensalidade selecionada #}
        {{ form.mensalidade.as_hidden }}
          <input type="hidden" name="mensalidades_ids" id="mensalidadesIds" value="">
        <!-- Buscar paciente -->
        <div>
          <label class="block text-sm font-bold text-slate-900 mb-2">
            üîç Buscar Paciente
          </label>

          <div class="relative">
            <input type="text"
                   id="pacienteBusca"
                   placeholder="Digite nome, telefone ou CPF..."
                   class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 text-lg"
                   autocomplete="off">

            <div id="pacienteResultados"
                 class="hidden absolute z-30 mt-2 w-full bg-white border border-slate-200 rounded-lg shadow-lg overflow-hidden">
              <div class="p-3 text-sm text-slate-600" id="pacienteResultadosHint">
                Digite para buscar pacientes...
              </div>
              <div id="pacienteResultadosLista" class="max-h-72 overflow-auto"></div>
            </div>
          </div>

          <div id="pacienteSelecionado"
               class="hidden mt-3 p-3 rounded-lg bg-green-50 border border-green-200 text-green-800 flex items-center justify-between gap-3">
            <div class="flex items-center gap-2">
              <i class="fas fa-check-circle"></i>
              <span id="pacienteSelecionadoNome" class="font-bold"></span>
            </div>
            <button type="button"
                    id="btnTrocarPaciente"
                    class="text-sm font-bold text-green-800 hover:text-green-900 underline">
              trocar
            </button>
          </div>

          <div id="erro-paciente" class="mt-2 hidden text-sm font-medium text-red-600"></div>
        </div>

        <!-- Lista de mensalidades do paciente -->
        <div>
          <label class="block text-sm font-bold text-slate-900 mb-2">
            üìå Mensalidades em aberto
          </label>

          <div id="mensalidadesHint" class="text-sm text-slate-600 mb-2">
            Selecione um paciente para listar as mensalidades.
          </div>

          <div id="resultadosMensalidades"
               class="hidden mt-2 max-h-96 overflow-y-auto border border-slate-200 rounded-lg bg-white shadow-lg"></div>

          <div id="erro-mensalidade" class="mt-2 hidden text-sm font-medium text-red-600"></div>
        </div>

        <!-- Detalhes da Mensalidade Selecionada -->
        <div id="detalhes-mensalidade" class="hidden">
          <div class="bg-blue-50 border-l-4 border-blue-500 p-5 rounded-r-lg">
            <h3 class="font-bold text-blue-900 mb-3">üìã Mensalidade Selecionada</h3>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <p class="text-xs text-blue-700">Paciente</p>
                <p class="text-sm font-bold text-blue-900" id="paciente-nome">-</p>
              </div>
              <div>
                <p class="text-xs text-blue-700">Servi√ßo</p>
                <p class="text-sm font-bold text-blue-900" id="servico-nome">-</p>
              </div>
              <div>
                <p class="text-xs text-blue-700">Valor da Mensalidade</p>
                <p class="text-sm font-bold text-green-600" id="mensalidade-valor">R$ 0,00</p>
              </div>
              <div>
                <p class="text-xs text-blue-700">Vencimento</p>
                <p class="text-sm font-bold text-blue-900" id="mensalidade-vencimento">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Valor Pago -->
        <div>
          <label for="id_valor_pago" class="block text-sm font-bold text-slate-900 mb-2">
            üíµ Valor Recebido (R$)
          </label>
          {{ form.valor_pago }}

          <div id="alerta-diferenca" class="mt-3 hidden"></div>

          <div id="div-ajustar-proxima" class="mt-3 hidden">
            <label class="flex items-center cursor-pointer bg-yellow-50 border border-yellow-300 rounded-lg p-3">
              {{ form.ajustar_proxima }}
              <span class="ml-2 text-sm font-medium text-yellow-900">
                <i class="fas fa-exchange-alt mr-1"></i>
                <span id="texto-ajuste">Ajustar diferen√ßa na pr√≥xima mensalidade</span>
              </span>
            </label>
          </div>
        </div>

        <!-- M√©todo de Pagamento -->
        <div>
          <label class="block text-sm font-bold text-slate-900 mb-2">
            M√©todo de Pagamento
          </label>

          <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
            {% for value, label in form.metodo_pagamento.field.choices %}
              <label class="relative flex items-center cursor-pointer">
                <input type="radio"
                       name="{{ form.metodo_pagamento.html_name }}"
                       value="{{ value }}"
                       class="sr-only peer"
                       {% if form.metodo_pagamento.value == value %}checked{% endif %}>
                <div class="w-full px-4 py-3 border-2 border-slate-300 rounded-lg peer-checked:border-purple-600 peer-checked:bg-purple-50 transition text-center font-medium text-slate-700 peer-checked:text-purple-600">
                  {% if value == 'dinheiro' %}
                    <i class="fas fa-money-bill mr-2"></i>
                  {% elif value == 'credito' %}
                    <i class="fas fa-credit-card mr-2"></i>
                  {% elif value == 'debito' %}
                    <i class="fas fa-credit-card mr-2"></i>
                  {% elif value == 'transferencia' %}
                    <i class="fas fa-exchange-alt mr-2"></i>
                  {% elif value == 'cheque' %}
                    <i class="fas fa-file-invoice mr-2"></i>
                  {% elif value == 'pix' %}
                    <i class="fas fa-qrcode mr-2"></i>
                  {% endif %}
                  {{ label }}
                </div>
              </label>
            {% endfor %}
          </div>
        </div>

        <!-- Observa√ß√µes -->
        <div>
          <label for="{{ form.observacoes.id_for_label }}" class="block text-sm font-bold text-slate-900 mb-2">
            Observa√ß√µes (Opcional)
          </label>
          {{ form.observacoes }}
        </div>

        <!-- Bot√µes -->
        <div class="flex gap-4 pt-4">
          <button type="submit" class="flex-1 px-6 py-3 bg-gradient-to-r from-purple-600 to-purple-700 text-white rounded-lg hover:shadow-lg transition font-bold flex items-center justify-center gap-2">
            <i class="fas fa-check-circle"></i>Registrar Pagamento
          </button>
          <a href="{% url 'dashboard_caixa' %}" class="flex-1 px-6 py-3 bg-slate-200 text-slate-800 rounded-lg hover:bg-slate-300 transition font-bold flex items-center justify-center gap-2">
            <i class="fas fa-times-circle"></i>Cancelar
          </a>
        </div>

      </form>
    </div>
  </div>
</div>

{# Modal: cadastrar paciente sem sair da tela (iframe) #}
<div id="modalPaciente" class="hidden fixed inset-0 z-50">
  <div class="absolute inset-0 bg-black/50" id="modalPacienteBackdrop"></div>

  <div class="relative mx-auto my-8 w-[95vw] max-w-4xl bg-white rounded-xl shadow-2xl overflow-hidden">
    <div class="flex items-center justify-between px-5 py-4 border-b border-slate-200">
      <h2 class="text-lg font-bold text-slate-900">
        <i class="fas fa-user-plus text-purple-600 mr-2"></i>Novo paciente
      </h2>
      <button type="button" id="btnFecharModalPaciente" class="px-3 py-2 rounded-lg hover:bg-slate-100">
        <i class="fas fa-times"></i>
      </button>
    </div>

    <div class="p-0">
      <iframe id="iframeCadastroPaciente"
              src="{% url 'cadastrar_paciente' %}?modal=1"
              class="w-full h-[75vh] border-0"></iframe>
    </div>

    <div class="px-5 py-4 border-t border-slate-200 text-sm text-slate-600">
      Ao salvar, o paciente ser√° selecionado automaticamente nesta tela.
    </div>
  </div>
</div>

<script>
(function () {
  // URLs
  const PACIENTE_SEARCH_URL = "{% url 'api_buscar_pacientes' %}";
  const MENSALIDADES_POR_PACIENTE_URL = "{% url 'api_mensalidades_por_paciente' %}";
  const MENSALIDADE_DETALHE_URL = "{% url 'api_detalhe_mensalidade' %}";

  // Elements
  const formPagamento = document.getElementById('formPagamento');

  const pacienteBusca = document.getElementById('pacienteBusca');
  const pacienteResultados = document.getElementById('pacienteResultados');
  const pacienteResultadosHint = document.getElementById('pacienteResultadosHint');
  const pacienteResultadosLista = document.getElementById('pacienteResultadosLista');

  const pacienteSelecionadoBox = document.getElementById('pacienteSelecionado');
  const pacienteSelecionadoNome = document.getElementById('pacienteSelecionadoNome');
  const btnTrocarPaciente = document.getElementById('btnTrocarPaciente');
  const erroPaciente = document.getElementById('erro-paciente');

  const mensalidadesHint = document.getElementById('mensalidadesHint');
  const resultadosMensalidades = document.getElementById('resultadosMensalidades');
  const erroMensalidadeDiv = document.getElementById('erro-mensalidade');

  const selectMensalidade = document.getElementById('id_mensalidade');

  const detalhesDiv = document.getElementById('detalhes-mensalidade');
  const valorPagoInput = document.getElementById('id_valor_pago');
  const alertaDiferenca = document.getElementById('alerta-diferenca');
  const divAjustarProxima = document.getElementById('div-ajustar-proxima');
  const textoAjuste = document.getElementById('texto-ajuste');

  // Modal
  const modal = document.getElementById('modalPaciente');
  const btnAbrirModal = document.getElementById('btnAbrirModalPaciente');
  const btnFecharModal = document.getElementById('btnFecharModalPaciente');
  const backdrop = document.getElementById('modalPacienteBackdrop');
  const hiddenMensalidadesIds = document.getElementById('mensalidadesIds');
  let mensalidadesSelecionadas = new Set(); // ids
  let mensalidadesCache = {}; // id -> mensalidade (com restante)
  
  // State
  let debounceTimer = null;
  let lastQuery = '';
  let pacienteSelecionado = null; // {id, nome, telefone, cpf, servico_id}
  let mensalidadeSelecionada = null;
  let permitirSubmit = false;

  function escapeHtml(s) {
    return (s || '').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
  }

  function mostrarErro(el, msg) {
    el.textContent = msg;
    el.classList.remove('hidden');
  }

  function limparErro(el) {
    el.textContent = '';
    el.classList.add('hidden');
  }

  // ===== Paciente autocomplete =====
  function abrirResultadosPaciente() { pacienteResultados.classList.remove('hidden'); }
  function fecharResultadosPaciente() { pacienteResultados.classList.add('hidden'); }
  function limparResultadosPaciente() { pacienteResultadosLista.innerHTML = ''; }
  function setHintPaciente(texto) { pacienteResultadosHint.textContent = texto; }

  async function buscarPacientes(q) {
    const url = `${PACIENTE_SEARCH_URL}?q=${encodeURIComponent(q)}`;
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!resp.ok) throw new Error('Falha ao buscar pacientes');
    return await resp.json();
  }

  function renderPacientes(items) {
    limparResultadosPaciente();

    if (!items || items.length === 0) {
      setHintPaciente('Nenhum paciente encontrado.');
      return;
    }

    setHintPaciente(`Encontrados: ${items.length}. Clique para selecionar.`);
    items.forEach((p) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'w-full text-left px-4 py-3 hover:bg-slate-50 border-t border-slate-100';

      const nome = escapeHtml(p.nome);
      const tel = p.telefone ? escapeHtml(p.telefone) : '';
      const cpf = p.cpf ? escapeHtml(p.cpf) : '';

      btn.innerHTML = `
        <div class="font-bold text-slate-900">${nome}</div>
        <div class="text-sm text-slate-600">
          ${tel ? `Tel: ${tel}` : ''}
          ${cpf ? `${tel ? ' ‚Ä¢ ' : ''}CPF: ${cpf}` : ''}
        </div>
      `;

      btn.addEventListener('click', () => selecionarPaciente(p));
      pacienteResultadosLista.appendChild(btn);
    });
  }

  async function carregarMensalidadesDoPaciente(pacienteId) {
    mensalidadesHint.textContent = 'Carregando mensalidades...';
    resultadosMensalidades.classList.add('hidden');
    resultadosMensalidades.innerHTML = '';
    limparErro(erroMensalidadeDiv);

    const url = `${MENSALIDADES_POR_PACIENTE_URL}?paciente_id=${encodeURIComponent(pacienteId)}`;
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!resp.ok) throw new Error('Falha ao carregar mensalidades');

    const data = await resp.json(); // esperado: [{id, servico, valor, vencimento, status, paciente_nome}, ...]
    return data;
  }

  function renderMensalidades(items) {
      resultadosMensalidades.innerHTML = '';

      // Atualiza cache (para somar total/restante e preencher detalhes depois)
      mensalidadesCache = {};
      (items || []).forEach((m) => { mensalidadesCache[String(m.id)] = m; });

      if (!items || items.length === 0) {
        mensalidadesHint.textContent = 'Nenhuma mensalidade em aberto para este paciente.';
        resultadosMensalidades.classList.add('hidden');

        // limpa sele√ß√£o
        mensalidadesSelecionadas = new Set();
        if (hiddenMensalidadesIds) hiddenMensalidadesIds.value = '';
        if (selectMensalidade) selectMensalidade.value = '';
        detalhesDiv.classList.add('hidden');
        return;
      }

      mensalidadesHint.textContent = 'Clique para marcar/desmarcar mensalidades:';
      resultadosMensalidades.classList.remove('hidden');

      function getValorCobrar(m) {
        // Se sua API j√° retornar "restante", usamos ele.
        // Sen√£o, cai no valor cheio.
        const v = (m.restante !== undefined && m.restante !== null) ? m.restante : m.valor;
        return Number(v) || 0;
      }

      function totalSelecionado() {
        let total = 0;
        Array.from(mensalidadesSelecionadas).forEach((id) => {
          const mm = mensalidadesCache[id];
          if (mm) total += getValorCobrar(mm);
        });
        return total;
      }

      function atualizarCamposDeSelecao() {
        const ids = Array.from(mensalidadesSelecionadas);

        // manda para o backend
        if (hiddenMensalidadesIds) hiddenMensalidadesIds.value = ids.join(',');

        // manter compatibilidade com seu form (mensalidade required):
        // coloca a primeira selecionada no select hidden
        if (selectMensalidade) selectMensalidade.value = ids.length ? ids[0] : '';

        // preenche o valor pago como soma (boa UX)
        if (valorPagoInput) valorPagoInput.value = ids.length ? totalSelecionado().toFixed(2) : '';

        // detalhes: mostra s√≥ se tiver exatamente 1 selecionada
        if (ids.length === 1) {
          const unico = mensalidadesCache[ids[0]];
          if (unico) selecionarMensalidade(unico);
        } else {
          detalhesDiv.classList.add('hidden');
          mensalidadeSelecionada = null;
          alertaDiferenca.classList.add('hidden');
          divAjustarProxima.classList.add('hidden');
        }
      }

      function alternarMensalidade(m) {
        limparErro(erroMensalidadeDiv);

        const id = String(m.id);
        if (mensalidadesSelecionadas.has(id)) mensalidadesSelecionadas.delete(id);
        else mensalidadesSelecionadas.add(id);

        // atualiza campos e re-render para refletir destaque visual
        atualizarCamposDeSelecao();
        renderMensalidades(items);
      }

      items.forEach((m) => {
        const statusClass = (m.status === 'vencida') ? 'border-red-500' : 'border-yellow-500';
        const statusText  = (m.status === 'vencida') ? 'text-red-600' : 'text-yellow-600';

        const idStr = String(m.id);
        const selecionado = mensalidadesSelecionadas.has(idStr);

        const card = document.createElement('button');
        card.type = 'button';
        card.className =
          `w-full text-left p-4 border-b border-l-4 ${statusClass} hover:bg-slate-50 cursor-pointer transition ` +
          (selecionado ? 'bg-purple-50 outline outline-2 outline-purple-600' : '');

        const valorCobrar = getValorCobrar(m);

        card.innerHTML = `
          <div class="flex justify-between items-center gap-4">
            <div>
              <p class="font-bold text-slate-900">${escapeHtml(m.paciente_nome || (pacienteSelecionado ? pacienteSelecionado.nome : ''))}</p>
              <p class="text-sm text-slate-600">${escapeHtml(m.servico)} - Vence em ${escapeHtml(m.vencimento)}</p>
            </div>
            <div class="text-right">
              <p class="font-bold text-green-600">R$ ${valorCobrar.toFixed(2)}</p>
              <p class="text-xs ${statusText} font-semibold">${String(m.status).toUpperCase()}</p>
            </div>
          </div>
        `;

        card.addEventListener('click', () => alternarMensalidade(m));
        resultadosMensalidades.appendChild(card);
      });

      // Se j√° tinha sele√ß√£o e voc√™ trocou de paciente, esse trecho garante consist√™ncia
      // (por exemplo, se ids selecionados n√£o existirem mais)
      Array.from(mensalidadesSelecionadas).forEach((id) => {
        if (!mensalidadesCache[id]) mensalidadesSelecionadas.delete(id);
      });
    }  
function setPacienteUI(pacienteId, pacienteNome) {
  pacienteSelecionado = { id: pacienteId, nome: pacienteNome };

  pacienteSelecionadoNome.textContent = pacienteNome || '(sem nome)';
  pacienteSelecionadoBox.classList.remove('hidden');

  pacienteBusca.value = pacienteNome || '';
  pacienteBusca.disabled = true;

  fecharResultadosPaciente();
}

  async function selecionarPaciente(p) {
    limparErro(erroPaciente);
    pacienteSelecionado = p;

    pacienteSelecionadoNome.textContent = p.nome || '(sem nome)';
    pacienteSelecionadoBox.classList.remove('hidden');

    pacienteBusca.value = p.nome || '';
    pacienteBusca.disabled = true;

    fecharResultadosPaciente();

    // reset mensalidade selecionada
    mensalidadeSelecionada = null;
    if (selectMensalidade) selectMensalidade.value = '';
    detalhesDiv.classList.add('hidden');
    mensalidadesSelecionadas = new Set();
    mensalidadesCache = {};
    if (hiddenMensalidadesIds) hiddenMensalidadesIds.value = '';

    try {
      const mensalidades = await carregarMensalidadesDoPaciente(p.id);
      renderMensalidades(mensalidades);
    } catch (e) {
      mostrarErro(erroMensalidadeDiv, 'N√£o foi poss√≠vel carregar mensalidades deste paciente.');
      mensalidadesHint.textContent = 'Erro ao carregar mensalidades.';
    }
  }

  function trocarPaciente() {
    pacienteSelecionado = null;
    pacienteBusca.value = '';
    pacienteBusca.disabled = false;
    pacienteSelecionadoBox.classList.add('hidden');
    pacienteBusca.focus();

    mensalidadesHint.textContent = 'Selecione um paciente para listar as mensalidades.';
    resultadosMensalidades.classList.add('hidden');
    resultadosMensalidades.innerHTML = '';

    mensalidadeSelecionada = null;
    if (selectMensalidade) selectMensalidade.value = '';
    detalhesDiv.classList.add('hidden');

    limparErro(erroPaciente);
    limparErro(erroMensalidadeDiv);
  }

  if (btnTrocarPaciente) btnTrocarPaciente.addEventListener('click', trocarPaciente);

  function onInputPaciente() {
    limparErro(erroPaciente);

    const q = (pacienteBusca.value || '').trim();
    lastQuery = q;

    abrirResultadosPaciente();

    if (q.length < 2) {
      limparResultadosPaciente();
      setHintPaciente('Digite pelo menos 2 letras...');
      return;
    }

    setHintPaciente('Buscando...');
    limparResultadosPaciente();

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(async () => {
      try {
        const data = await buscarPacientes(q);
        if (lastQuery !== q) return;
        renderPacientes(data);
      } catch (e) {
        limparResultadosPaciente();
        setHintPaciente('Erro ao buscar. Tente novamente.');
      }
    }, 250);
  }

  if (pacienteBusca) {
    pacienteBusca.addEventListener('input', onInputPaciente);
    pacienteBusca.addEventListener('focus', () => abrirResultadosPaciente());
  }

  document.addEventListener('click', (e) => {
    const clicouDentro = pacienteResultados.contains(e.target) || pacienteBusca.contains(e.target);
    if (!clicouDentro) fecharResultadosPaciente();
  });

  function valorCobrar(m) {
  const v = (m.restante !== undefined && m.restante !== null) ? m.restante : m.valor;
  return Number(v) || 0;
}

  // ===== Selecionar mensalidade =====
  function selecionarMensalidade(m) {
  limparErro(erroMensalidadeDiv);

  mensalidadeSelecionada = m;

  // ‚úÖ cobrar = restante (se existir) sen√£o valor
  const cobrar = Number(
    (m.restante !== undefined && m.restante !== null) ? m.restante : m.valor
  ) || 0;

  // preencher detalhes
  document.getElementById('paciente-nome').textContent =
    m.paciente_nome || (pacienteSelecionado ? pacienteSelecionado.nome : '-');
  document.getElementById('servico-nome').textContent = m.servico || '-';
  document.getElementById('mensalidade-valor').textContent = 'R$ ' + cobrar.toFixed(2);
  document.getElementById('mensalidade-vencimento').textContent = m.vencimento || '-';

  // preencher hidden (mant√©m compatibilidade com seu form)
  if (selectMensalidade) selectMensalidade.value = String(m.id);

  // preencher valor recebido (somente em modo 1 sele√ß√£o)
  if (valorPagoInput && (!mensalidadesSelecionadas || mensalidadesSelecionadas.size <= 1)) {
    valorPagoInput.value = cobrar.toFixed(2);
  }

  detalhesDiv.classList.remove('hidden');
  verificarDiferenca();
}
  // ===== Diferen√ßa de valor =====
  function verificarDiferenca() {
    if (!mensalidadeSelecionada) return;

   const valorMensalidade = Number((mensalidadeSelecionada.restante !== undefined && mensalidadeSelecionada.restante !== null)
    
  ? mensalidadeSelecionada.restante
  : mensalidadeSelecionada.valor) || 0;
    const valorPago = parseFloat(valorPagoInput.value) || 0;
    const diferenca = valorPago - valorMensalidade;

    if (Math.abs(diferenca) > 0.01) {
      if (diferenca > 0) {
        alertaDiferenca.className = 'mt-3 bg-blue-50 border-l-4 border-blue-500 p-4 rounded-r-lg';
        alertaDiferenca.innerHTML = `
          <p class="text-sm text-blue-900">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Valor maior que a mensalidade!</strong> Diferen√ßa de <strong>R$ ${diferenca.toFixed(2)}</strong> a favor do paciente.
          </p>
        `;
        textoAjuste.textContent = `Abater R$ ${diferenca.toFixed(2)} da pr√≥xima mensalidade`;
      } else {
        alertaDiferenca.className = 'mt-3 bg-yellow-50 border-l-4 border-yellow-500 p-4 rounded-r-lg';
        alertaDiferenca.innerHTML = `
          <p class="text-sm text-yellow-900">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <strong>Valor menor que a mensalidade!</strong> Faltam <strong>R$ ${Math.abs(diferenca).toFixed(2)}</strong>.
          </p>
        `;
        textoAjuste.textContent = `Adicionar R$ ${Math.abs(diferenca).toFixed(2)} na pr√≥xima mensalidade`;
      }
      alertaDiferenca.classList.remove('hidden');
      divAjustarProxima.classList.remove('hidden');
    } else {
      alertaDiferenca.classList.add('hidden');
      divAjustarProxima.classList.add('hidden');
    }
  }

  if (valorPagoInput) valorPagoInput.addEventListener('input', verificarDiferenca);

  // ===== Submit =====
  formPagamento.addEventListener('submit', function(e) {
    if (permitirSubmit) return;

    e.preventDefault();
    limparErro(erroPaciente);
    limparErro(erroMensalidadeDiv);

    if (!pacienteSelecionado) {
      mostrarErro(erroPaciente, 'Selecione um paciente antes de escolher a mensalidade.');
      pacienteBusca.disabled = false;
      pacienteBusca.focus();
      return;
    }
      const ids = hiddenMensalidadesIds ? (hiddenMensalidadesIds.value || '').trim() : '';
      if (!ids) {
        mostrarErro(erroMensalidadeDiv, 'Selecione pelo menos uma mensalidade antes de registrar o pagamento.');
        return;
      }
    permitirSubmit = true;
    formPagamento.submit();
  });

  // ===== Modal =====
  function abrirModal() { modal.classList.remove('hidden'); }
  function fecharModal() { modal.classList.add('hidden'); }

  if (btnAbrirModal) btnAbrirModal.addEventListener('click', abrirModal);
  if (btnFecharModal) btnFecharModal.addEventListener('click', fecharModal);
  if (backdrop) backdrop.addEventListener('click', fecharModal);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && !modal.classList.contains('hidden')) fecharModal();
  });

  // Receber paciente criado no iframe
  window.addEventListener('message', (event) => {
    if (event.origin !== window.location.origin) return;

    const data = event.data || {};
    if (data.type !== 'paciente_criado') return;

    const p = data.paciente;
    if (!p || !p.id) return;

    selecionarPaciente(p);
    fecharModal();
  });
  (async function carregarMensalidadeInicialSeHouver() {
  // tenta pegar do hidden (preferido). fallback no context.
  const inicialHidden = (selectMensalidade && selectMensalidade.value) ? String(selectMensalidade.value) : '';
  const inicialContext = "{{ mensalidade_id_inicial|default:''|escapejs }}";
  const inicial = inicialHidden || inicialContext;

  if (!inicial) return;

  try {
    const url = `${MENSALIDADE_DETALHE_URL}?mensalidade_id=${encodeURIComponent(inicial)}`;
    const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });
    if (!resp.ok) return;

    const m = await resp.json();
    if (!m || !m.id || !m.paciente_id) return;

    // 1) seta paciente na UI
    setPacienteUI(m.paciente_id, m.paciente_nome);

    // 2) carrega lista do paciente
    const lista = await carregarMensalidadesDoPaciente(m.paciente_id);
    renderMensalidades(lista);

    // 3) seleciona a mensalidade inicial e preenche detalhes
    selecionarMensalidade(m);

  } catch (e) {
    // deixa silencioso pra n√£o travar a p√°gina
  }
})();
})();
</script>
{% endblock %}